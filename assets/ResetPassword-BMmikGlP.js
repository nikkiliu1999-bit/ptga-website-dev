import{_ as D,r,x as q,s as b,c as l,a,F as B,d as C,b as u,w as E,e as P,v as L,n as w,t as _,h as x,l as F,o,m as N}from"./index-D6iBOoDI.js";const T={class:"reset-password-page"},z={class:"bubbles"},I={class:"reset-card"},$={class:"card-body"},j={class:"input-group"},A={key:0,class:"error-hint"},G={class:"input-group"},H=["disabled"],J={key:0},K={key:1,class:"loading"},O={key:1,class:"loading-state"},Q={key:3,class:"error-message"},W={__name:"ResetPassword",setup(X){const k=F(),c=r(""),g=r(""),p=r(!1),v=r(""),f=r(!1),d=r(""),n=r(!1),i=r("无效的重置链接，请重新申请"),m=r(!0),h=r(""),y=r(""),R=e=>{const t=[{width:"40px",height:"40px",left:"10%",duration:"8s",delay:"0s"},{width:"20px",height:"20px",left:"20%",duration:"5s",delay:"1s"},{width:"50px",height:"50px",left:"35%",duration:"7s",delay:"2s"},{width:"80px",height:"80px",left:"50%",duration:"11s",delay:"0s"},{width:"35px",height:"35px",left:"55%",duration:"6s",delay:"1s"},{width:"45px",height:"45px",left:"65%",duration:"8s",delay:"3s"},{width:"90px",height:"90px",left:"70%",duration:"12s",delay:"2s"},{width:"25px",height:"25px",left:"80%",duration:"6s",delay:"2s"},{width:"15px",height:"15px",left:"70%",duration:"5s",delay:"1s"},{width:"90px",height:"90px",left:"25%",duration:"10s",delay:"4s"}][e-1];return{width:t.width,height:t.height,left:t.left,animationDuration:t.duration,animationDelay:t.delay}},S=()=>{const e={access_token:"",type:"",error:"",error_code:"",error_description:""};if(window.location.hash){const s=new URLSearchParams(window.location.hash.slice(1));e.access_token=s.get("access_token")||"",e.type=s.get("type")||"",e.error=s.get("error")||"",e.error_code=s.get("error_code")||"",e.error_description=s.get("error_description")||""}return e};q(async()=>{try{const e=S();if(console.log("解析到的重置链接参数:",e),h.value=e.access_token,y.value=e.type,e.error){n.value=!0,e.error_code==="otp_expired"?i.value="重置链接已过期，请重新申请":e.error==="access_denied"?i.value="重置链接无效或已被使用":i.value=`链接错误: ${e.error_description||e.error}`;return}if(!h.value){n.value=!0,i.value="链接缺少必要的令牌参数",console.error("未找到access_token参数");return}if(!y.value||y.value!=="recovery"){n.value=!0,i.value="链接类型不正确",console.error("无效的type参数:",y.value);return}const{data:{user:s},error:t}=await b.auth.getUser(h.value);if(t||!s)throw new Error(t?.message||"链接已失效，请重新申请");n.value=!1}catch(e){n.value=!0,i.value=e.message||"链接验证失败，请重新申请",console.error("链接验证错误:",e)}finally{m.value=!1}});const U=()=>c.value.length<6?(d.value="密码长度不能少于6位",!1):c.value!==g.value?(d.value="两次输入的密码不一致",!1):(d.value="",!0),M=async()=>{if(U()&&h.value){p.value=!0,v.value="";try{const{error:e}=await b.auth.updateUser(h.value,{password:c.value});if(e)throw e;f.value=!0,v.value="密码重置成功，3秒后跳转到登录页...",setTimeout(()=>{k.push("/login")},3e3)}catch(e){f.value=!1,v.value=e.message||"密码重置失败，请重试",console.error("密码重置错误:",e),(e.message.includes("expired")||e.message.includes("invalid"))&&(n.value=!0,i.value="链接已过期或无效，请重新申请")}finally{p.value=!1}}},V=()=>{k.push({name:"Login",query:{showForgotModal:"true"}})};return(e,s)=>(o(),l("div",T,[a("div",z,[(o(),l(B,null,C(10,t=>a("div",{key:t,class:"bubble",style:N(R(t))},null,4)),64))]),a("div",I,[s[7]||(s[7]=a("div",{class:"card-header"},[a("div",{class:"logo"},[a("i",{class:"fas fa-key"})]),a("h2",null,"重置密码"),a("p",null,"请设置您的新密码")],-1)),a("div",$,[!n.value&&!m.value?(o(),l("form",{key:0,onSubmit:E(M,["prevent"])},[a("div",j,[s[2]||(s[2]=a("i",{class:"fas fa-lock"},null,-1)),P(a("input",{"onUpdate:modelValue":s[0]||(s[0]=t=>c.value=t),type:"password",required:"",placeholder:"新密码（至少6位）",class:w({"error-border":d.value})},null,2),[[L,c.value]])]),d.value?(o(),l("p",A,_(d.value),1)):u("",!0),a("div",G,[s[3]||(s[3]=a("i",{class:"fas fa-lock"},null,-1)),P(a("input",{"onUpdate:modelValue":s[1]||(s[1]=t=>g.value=t),type:"password",required:"",placeholder:"确认新密码"},null,512),[[L,g.value]])]),a("button",{type:"submit",disabled:p.value,class:"reset-btn"},[p.value?u("",!0):(o(),l("span",J,"确认重置")),p.value?(o(),l("span",K,s[4]||(s[4]=[a("span",{class:"spinner"},null,-1),x(" 处理中... ",-1)]))):u("",!0)],8,H)],32)):u("",!0),m.value?(o(),l("div",O,s[5]||(s[5]=[a("span",{class:"spinner"},null,-1),a("p",null,"验证链接有效性...",-1)]))):u("",!0),v.value?(o(),l("div",{key:2,class:w(f.value?"success-message":"error-message")},[a("i",{class:w(f.value?"fas fa-check-circle":"fas fa-exclamation-circle")},null,2),x(" "+_(v.value),1)],2)):u("",!0),n.value?(o(),l("div",Q,[s[6]||(s[6]=a("i",{class:"fas fa-exclamation-circle"},null,-1)),x(" "+_(i.value)+" ",1),a("button",{class:"resend-btn",onClick:V}," 重新发送重置链接 ")])):u("",!0)])])]))}},Z=D(W,[["__scopeId","data-v-21738547"]]);export{Z as default};
